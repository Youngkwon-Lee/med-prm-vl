<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Med-PRM Data Flow - Case Study</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            color: #1a1a2e;
            line-height: 1.7;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            text-align: center;
            padding: 50px 20px;
            background: linear-gradient(135deg, #1a365d 0%, #2d4a6f 100%);
            color: white;
            margin-bottom: 40px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .case-intro {
            background: #f0f9ff;
            border: 2px solid #0284c7;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
        }

        .case-intro h2 {
            color: #0369a1;
            margin-bottom: 15px;
        }

        .question-box {
            background: #fff;
            border-left: 5px solid #0284c7;
            padding: 20px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .question-box .q-label {
            color: #0369a1;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .options {
            margin-top: 15px;
        }

        .options div {
            padding: 8px 15px;
            margin: 5px 0;
            background: #f8fafc;
            border-radius: 6px;
        }

        .options .correct {
            background: #d1fae5;
            border: 1px solid #059669;
            font-weight: 600;
        }

        .stage {
            background: #fff;
            border-radius: 12px;
            margin-bottom: 35px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .stage-header {
            background: #1a365d;
            color: white;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stage-number {
            background: white;
            color: #1a365d;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .stage-header h3 {
            font-size: 1.3em;
        }

        .stage-header .file-name {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-left: auto;
        }

        .stage-content {
            padding: 30px;
        }

        .data-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .data-box h4 {
            color: #1a365d;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .data-box h4::before {
            content: "ğŸ“„";
        }

        .arrow-down {
            text-align: center;
            padding: 15px;
            font-size: 2em;
            color: #64748b;
        }

        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.88em;
            line-height: 1.6;
            margin: 10px 0;
        }

        .json-key {
            color: #7dd3fc;
        }

        .json-string {
            color: #86efac;
        }

        .json-number {
            color: #fcd34d;
        }

        .step-marker {
            background: #fef3c7;
            color: #92400e;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .step-good {
            background: #d1fae5;
            color: #065f46;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .step-bad {
            background: #fee2e2;
            color: #991b1b;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            margin: 20px 0;
        }

        .flow-box {
            background: #1a365d;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            min-width: 120px;
        }

        .flow-box.highlight {
            background: #0284c7;
        }

        .flow-box.success {
            background: #059669;
        }

        .flow-arrow {
            font-size: 1.5em;
            color: #64748b;
        }

        .info-callout {
            background: #eff6ff;
            border-left: 4px solid #2563eb;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .warning-callout {
            background: #fef3c7;
            border-left: 4px solid #d97706;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .success-callout {
            background: #d1fae5;
            border-left: 4px solid #059669;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid #e2e8f0;
        }

        th {
            background: #1a365d;
            color: white;
        }

        tr:nth-child(even) {
            background: #f8fafc;
        }

        .score-bar {
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #059669, #34d399);
            border-radius: 10px;
        }

        .solution-card {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }

        .solution-card.selected {
            border-color: #059669;
        }

        .solution-header {
            background: #f1f5f9;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .solution-header.selected {
            background: #d1fae5;
        }

        .solution-body {
            padding: 20px;
        }

        .step-scores {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .step-score {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .step-score.high {
            background: #d1fae5;
            color: #065f46;
        }

        .step-score.medium {
            background: #fef3c7;
            color: #92400e;
        }

        .step-score.low {
            background: #fee2e2;
            color: #991b1b;
        }

        code {
            background: #f1f5f9;
            color: #1a365d;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
        }

        footer {
            text-align: center;
            padding: 30px;
            color: #64748b;
            border-top: 1px solid #e2e8f0;
            margin-top: 40px;
        }
    </style>
</head>
<body>

<header>
    <h1>Med-PRM Data Flow - Case Study</h1>
    <p>í•˜ë‚˜ì˜ MedQA ë¬¸ì œë¡œ ë³´ëŠ” ì „ì²´ íŒŒì´í”„ë¼ì¸</p>
</header>

<div class="container">

    <!-- Case Introduction -->
    <div class="case-intro">
        <h2>ğŸ¥ ì˜ˆì‹œ ì¼€ì´ìŠ¤: MedQA ë¬¸ì œ</h2>
        <div class="question-box">
            <div class="q-label">Question (ë¬¸ì œ)</div>
            <p>A 65-year-old man presents with progressive shortness of breath and a productive cough for the past 3 months. He has a 40-pack-year smoking history. Physical examination reveals decreased breath sounds and hyperresonance on percussion. Chest X-ray shows flattened diaphragms. What is the most likely diagnosis?</p>
            <div class="options">
                <div>(A) Asthma</div>
                <div>(B) Bronchiectasis</div>
                <div class="correct">(C) Chronic obstructive pulmonary disease (COPD) âœ“</div>
                <div>(D) Lung cancer</div>
            </div>
        </div>
        <p style="margin-top: 15px; color: #64748b;"><strong>ì •ë‹µ:</strong> (C) COPD - 40 pack-year í¡ì—°ë ¥, í˜¸í¡ê³¤ë€, flattened diaphragmsê°€ ì§„ë‹¨ ê·¼ê±°</p>
    </div>

    <!-- Stage 0: Data Preparation -->
    <div class="stage">
        <div class="stage-header">
            <div class="stage-number">0</div>
            <h3>ë°ì´í„° ì¤€ë¹„ (Data Preparation)</h3>
            <span class="file-name">0_preparing.py</span>
        </div>
        <div class="stage-content">
            <p>HuggingFaceì—ì„œ MedQA ë°ì´í„°ì…‹ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.</p>

            <div class="data-box">
                <h4>ì‹¤í–‰ ì½”ë“œ</h4>
                <pre>from huggingface_hub import snapshot_download

# MedQA í•™ìŠµ ë°ì´í„°ì…‹ ë‹¤ìš´ë¡œë“œ
snapshot_download(
    repo_id="luckychao/llama-3.1-medprm-reward-training-set",
    repo_type="dataset",
    local_dir="./dataset/reward-training-set"
)</pre>
            </div>

            <div class="arrow-down">â¬‡ï¸</div>

            <div class="data-box">
                <h4>ë‹¤ìš´ë¡œë“œëœ ì›ë³¸ ë°ì´í„° (JSON)</h4>
                <pre>{
    <span class="json-key">"question"</span>: <span class="json-string">"A 65-year-old man presents with progressive shortness of breath..."</span>,
    <span class="json-key">"options"</span>: {
        <span class="json-key">"A"</span>: <span class="json-string">"Asthma"</span>,
        <span class="json-key">"B"</span>: <span class="json-string">"Bronchiectasis"</span>,
        <span class="json-key">"C"</span>: <span class="json-string">"Chronic obstructive pulmonary disease (COPD)"</span>,
        <span class="json-key">"D"</span>: <span class="json-string">"Lung cancer"</span>
    },
    <span class="json-key">"answer"</span>: <span class="json-string">"C"</span>,
    <span class="json-key">"data_source"</span>: <span class="json-string">"medqa"</span>
}</pre>
            </div>

            <div class="info-callout">
                <strong>ë°ì´í„° êµ¬ì¡°:</strong> ê° ë¬¸ì œëŠ” question, options (A-D), ì •ë‹µ answer, ê·¸ë¦¬ê³  ì¶œì²˜ data_sourceë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
            </div>
        </div>
    </div>

    <!-- Stage 1: Solution Generation + RAG Judge Labeling -->
    <div class="stage">
        <div class="stage-header">
            <div class="stage-number">1</div>
            <h3>ì†”ë£¨ì…˜ ìƒì„± + RAG Judge ë ˆì´ë¸”ë§</h3>
            <span class="file-name">1_train_dataset_RAG_judge_labeling.py</span>
        </div>
        <div class="stage-content">

            <div class="flow-diagram">
                <div class="flow-box">Policy Model</div>
                <span class="flow-arrow">â†’</span>
                <div class="flow-box highlight">ì†”ë£¨ì…˜ ìƒì„±</div>
                <span class="flow-arrow">â†’</span>
                <div class="flow-box highlight">RAG Judge</div>
                <span class="flow-arrow">â†’</span>
                <div class="flow-box success">Step Labels</div>
            </div>

            <h4 style="margin-top: 25px; color: #1a365d;">Step 1-1: Policy Modelì´ ì†”ë£¨ì…˜ ìƒì„±</h4>
            <div class="data-box">
                <h4>Policy Model ì…ë ¥ (System Prompt)</h4>
                <pre>You are a medical expert. Solve the following medical question
step by step. Show your reasoning clearly and end with
"The answer is (X)" where X is the option letter.</pre>
            </div>

            <div class="data-box">
                <h4>Policy Model ì¶œë ¥ (ìƒì„±ëœ ì†”ë£¨ì…˜)</h4>
                <pre>## Step 1: Analyze the patient's history
The patient is a 65-year-old man with a 40-pack-year smoking history.
This significant tobacco exposure is a major risk factor for
smoking-related lung diseases. <span class="step-marker">ĞºĞ¸</span>

## Step 2: Evaluate the symptoms
Progressive shortness of breath and productive cough for 3 months
suggests a chronic pulmonary condition rather than acute illness. <span class="step-marker">ĞºĞ¸</span>

## Step 3: Interpret physical examination findings
Decreased breath sounds and hyperresonance on percussion indicate
air trapping in the lungs, consistent with obstructive lung disease. <span class="step-marker">ĞºĞ¸</span>

## Step 4: Analyze chest X-ray findings
Flattened diaphragms on chest X-ray is a classic sign of lung
hyperinflation, strongly suggesting emphysema/COPD. <span class="step-marker">ĞºĞ¸</span>

## Step 5: Differential diagnosis
- Asthma: Usually presents earlier in life, reversible obstruction
- COPD: Matches all findings - smoking history, age, symptoms, imaging
- Bronchiectasis: Would show different X-ray findings
- Lung cancer: Would present with mass on X-ray <span class="step-marker">ĞºĞ¸</span>

## Final Answer
The answer is \boxed{C} <span class="step-marker">ĞºĞ¸</span></pre>
            </div>

            <div class="warning-callout">
                <strong>ĞºĞ¸ (step marker):</strong> ê° ì¶”ë¡  ë‹¨ê³„ì˜ ëì— íŠ¹ìˆ˜ ë¬¸ì "ĞºĞ¸"ê°€ ì‚½ì…ë©ë‹ˆë‹¤. ì´ ë§ˆì»¤ëŠ” PRMì´ ê° ë‹¨ê³„ë¥¼ í‰ê°€í•˜ëŠ” ìœ„ì¹˜ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
            </div>

            <h4 style="margin-top: 30px; color: #1a365d;">Step 1-2: RAG-AS-A-JUDGEë¡œ ê° Step ê²€ì¦</h4>

            <div class="data-box">
                <h4>RAG Judge í”„ë¡œì„¸ìŠ¤</h4>
                <pre># ê° Stepë§ˆë‹¤ RAGë¡œ ì˜í•™ ë¬¸í—Œ ê²€ìƒ‰ í›„ ê²€ì¦

<span style="color: #86efac;">## Step 1 ê²€ì¦</span>
[RAG ê²€ìƒ‰] "40-pack-year smoking COPD risk factor"
[ê²€ìƒ‰ ê²°ê³¼] "Smoking is the primary risk factor for COPD.
            A 40-pack-year history significantly increases COPD risk."
[Judge íŒì •] <span class="step-good">+ (Correct)</span> - ì˜í•™ì ìœ¼ë¡œ ì •í™•í•œ ì§„ìˆ 

<span style="color: #86efac;">## Step 2 ê²€ì¦</span>
[RAG ê²€ìƒ‰] "COPD symptoms progressive dyspnea productive cough"
[ê²€ìƒ‰ ê²°ê³¼] "COPD typically presents with progressive dyspnea
            and chronic productive cough."
[Judge íŒì •] <span class="step-good">+ (Correct)</span> - ì¦ìƒ í•´ì„ì´ ì •í™•í•¨

<span style="color: #86efac;">## Step 3 ê²€ì¦</span>
[RAG ê²€ìƒ‰] "COPD physical exam hyperresonance decreased breath sounds"
[ê²€ìƒ‰ ê²°ê³¼] "Physical findings in COPD include hyperresonance,
            decreased breath sounds, and prolonged expiration."
[Judge íŒì •] <span class="step-good">+ (Correct)</span> - ì‹ ì²´ê²€ì‚¬ í•´ì„ ì •í™•

<span style="color: #86efac;">## Step 4 ê²€ì¦</span>
[RAG ê²€ìƒ‰] "flattened diaphragm chest xray COPD emphysema"
[ê²€ìƒ‰ ê²°ê³¼] "Flattened diaphragms on CXR indicate hyperinflation,
            a hallmark of emphysema/COPD."
[Judge íŒì •] <span class="step-good">+ (Correct)</span> - ì˜ìƒ í•´ì„ ì •í™•

<span style="color: #86efac;">## Step 5 ê²€ì¦</span>
[RAG ê²€ìƒ‰] "differential diagnosis COPD asthma bronchiectasis"
[ê²€ìƒ‰ ê²°ê³¼] "COPD vs Asthma: COPD is irreversible, smoking-related..."
[Judge íŒì •] <span class="step-good">+ (Correct)</span> - ê°ë³„ì§„ë‹¨ ë…¼ë¦¬ ì •í™•

<span style="color: #86efac;">## Final Answer ê²€ì¦</span>
[ì •ë‹µ ë¹„êµ] ì˜ˆì¸¡: C, ì‹¤ì œ ì •ë‹µ: C
[Judge íŒì •] <span class="step-good">+ (Correct)</span></pre>
            </div>

            <div class="arrow-down">â¬‡ï¸</div>

            <div class="data-box">
                <h4>ë ˆì´ë¸”ë§ëœ í•™ìŠµ ë°ì´í„° (Output)</h4>
                <pre>{
    <span class="json-key">"question"</span>: <span class="json-string">"A 65-year-old man presents with..."</span>,
    <span class="json-key">"answer"</span>: <span class="json-string">"C"</span>,
    <span class="json-key">"prm_processed_solution"</span>: <span class="json-string">"## Step 1: Analyze... ĞºĞ¸\n## Step 2: Evaluate... ĞºĞ¸\n..."</span>,
    <span class="json-key">"step_labels"</span>: [<span class="json-number">1, 1, 1, 1, 1, 1</span>],  <span style="color: #86efac;">// ëª¨ë“  stepì´ correct (+)</span>
    <span class="json-key">"orm_label"</span>: <span class="json-number">1</span>,  <span style="color: #86efac;">// ìµœì¢… ë‹µì´ correct</span>
    <span class="json-key">"extracted_answer"</span>: <span class="json-string">"C"</span>,
    <span class="json-key">"score"</span>: <span class="json-number">1</span>
}</pre>
            </div>

            <div class="info-callout">
                <strong>ë ˆì´ë¸” ì˜ë¯¸:</strong><br>
                â€¢ <code>step_labels: [1,1,1,1,1,1]</code> - ê° ë‹¨ê³„ê°€ ì˜¬ë°”ë¥´ë©´ 1, í‹€ë¦¬ë©´ 0<br>
                â€¢ <code>orm_label: 1</code> - ìµœì¢… ë‹µë³€ì´ ë§ìœ¼ë©´ 1 (Outcome Reward)<br>
                â€¢ <code>score: 1</code> - ì „ì²´ ì†”ë£¨ì…˜ ì •í™•ë„
            </div>
        </div>
    </div>

    <!-- Stage 2: Training -->
    <div class="stage">
        <div class="stage-header">
            <div class="stage-number">2</div>
            <h3>PRM ëª¨ë¸ í•™ìŠµ (Training)</h3>
            <span class="file-name">2_training.py</span>
        </div>
        <div class="stage-content">

            <div class="flow-diagram">
                <div class="flow-box">Labeled Data</div>
                <span class="flow-arrow">â†’</span>
                <div class="flow-box highlight">Tokenize</div>
                <span class="flow-arrow">â†’</span>
                <div class="flow-box highlight">Binary Loss</div>
                <span class="flow-arrow">â†’</span>
                <div class="flow-box success">Trained PRM</div>
            </div>

            <h4 style="margin-top: 25px; color: #1a365d;">Step 2-1: ë°ì´í„° í† í¬ë‚˜ì´ì§•</h4>

            <div class="data-box">
                <h4>Chat Template ì ìš©</h4>
                <pre># System Prompt + Question + Solutionì„ Chat í˜•ì‹ìœ¼ë¡œ ë³€í™˜

messages = [
    {
        "role": "system",
        "content": "You are evaluating medical reasoning steps..."
    },
    {
        "role": "user",
        "content": "Question: A 65-year-old man presents with...\n\n
                   Options: (A) Asthma (B) Bronchiectasis..."
    },
    {
        "role": "assistant",
        "content": "## Step 1: Analyze the patient's history... ĞºĞ¸\n
                   ## Step 2: Evaluate the symptoms... ĞºĞ¸\n..."
    }
]

# Tokenize
input_ids = tokenizer.apply_chat_template(messages, tokenize=True)
# [1, 529, 29989, 5765, ..., 29871, 529, ...]  # í† í° ID ì‹œí€€ìŠ¤</pre>
            </div>

            <h4 style="margin-top: 25px; color: #1a365d;">Step 2-2: Loss ê³„ì‚° (Binary Classification)</h4>

            <div class="data-box">
                <h4>Step-wise Binary Classification Loss</h4>
                <pre># ê° "ĞºĞ¸" ìœ„ì¹˜ì—ì„œ "+ / -" í† í°ì— ëŒ€í•œ í™•ë¥  ê³„ì‚°

<span style="color: #fcd34d;"># Step 1 ìœ„ì¹˜ì—ì„œ</span>
logits_at_step1 = model(input_ids)[step1_position]
plus_logit = logits_at_step1[plus_token_id]   # " +" í† í°ì˜ logit
minus_logit = logits_at_step1[minus_token_id] # " -" í† í°ì˜ logit

# Softmaxë¡œ í™•ë¥  ê³„ì‚°
probs = softmax([plus_logit, minus_logit])  # [0.92, 0.08]

<span style="color: #fcd34d;"># Ground Truth</span>
gt_label = step_labels[0]  # 1 (correct step)
gt = [1.0, 0.0]  # positiveê°€ ì •ë‹µ

<span style="color: #fcd34d;"># Cross Entropy Loss</span>
loss = cross_entropy(probs, gt)
# ëª¨ë¸ì´ "+"ë¥¼ ë†’ê²Œ ì˜ˆì¸¡í•˜ë„ë¡ í•™ìŠµ</pre>
            </div>

            <div class="data-box">
                <h4>ì „ì²´ Loss ì§‘ê³„</h4>
                <pre><span style="color: #86efac;"># ëª¨ë“  Stepì˜ Loss í•©ì‚°</span>

total_loss = 0
for step_idx, step_position in enumerate(step_positions):
    logits = model(input_ids)[step_position]
    pred = softmax([logits[plus_id], logits[minus_id]])

    gt_value = step_labels[step_idx]  # 0 or 1
    gt = [gt_value, 1 - gt_value]

    total_loss += cross_entropy(pred, gt)

avg_loss = total_loss / len(step_positions)
avg_loss.backward()  # Gradient ê³„ì‚°</pre>
            </div>

            <div class="info-callout">
                <strong>í•™ìŠµ ëª©í‘œ:</strong> PRMì´ ê° ì¶”ë¡  ë‹¨ê³„ì˜ "ĞºĞ¸" ë§ˆì»¤ ìœ„ì¹˜ì—ì„œ ì˜¬ë°”ë¥¸ ë‹¨ê³„ì—ëŠ” "+" í† í°ì„, ì˜ëª»ëœ ë‹¨ê³„ì—ëŠ” "-" í† í°ì„ ë†’ì€ í™•ë¥ ë¡œ ì˜ˆì¸¡í•˜ë„ë¡ í•™ìŠµí•©ë‹ˆë‹¤.
            </div>

            <h4 style="margin-top: 25px; color: #1a365d;">í•™ìŠµ ì„¤ì •</h4>
            <table>
                <tr>
                    <th>íŒŒë¼ë¯¸í„°</th>
                    <th>ê°’</th>
                    <th>ì„¤ëª…</th>
                </tr>
                <tr>
                    <td>Base Model</td>
                    <td>Llama-3.1-8B-Instruct</td>
                    <td>ì‚¬ì „í•™ìŠµëœ ê¸°ë°˜ ëª¨ë¸</td>
                </tr>
                <tr>
                    <td>Learning Rate</td>
                    <td>2e-6</td>
                    <td>ë¯¸ì„¸ì¡°ì •ìš© ë‚®ì€ í•™ìŠµë¥ </td>
                </tr>
                <tr>
                    <td>Epochs</td>
                    <td>3</td>
                    <td>ì „ì²´ ë°ì´í„° 3íšŒ í•™ìŠµ</td>
                </tr>
                <tr>
                    <td>Effective Batch</td>
                    <td>64</td>
                    <td>1 Ã— 64 gradient accumulation</td>
                </tr>
                <tr>
                    <td>Max Length</td>
                    <td>4096</td>
                    <td>RAG ë¬¸ì„œ í¬í•¨ ì‹œ í•„ìš”</td>
                </tr>
            </table>
        </div>
    </div>

    <!-- Stage 3: Test Sampling (Inference) -->
    <div class="stage">
        <div class="stage-header">
            <div class="stage-number">3</div>
            <h3>í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒ˜í”Œë§ (Inference)</h3>
            <span class="file-name">3_test_dataset_sampling.py</span>
        </div>
        <div class="stage-content">

            <div class="flow-diagram">
                <div class="flow-box">Test Question</div>
                <span class="flow-arrow">â†’</span>
                <div class="flow-box highlight">Policy Model</div>
                <span class="flow-arrow">â†’</span>
                <div class="flow-box highlight">Nê°œ ì†”ë£¨ì…˜</div>
                <span class="flow-arrow">â†’</span>
                <div class="flow-box success">Best-of-N í›„ë³´</div>
            </div>

            <h4 style="margin-top: 25px; color: #1a365d;">Best-of-Nì„ ìœ„í•œ ë‹¤ì¤‘ ì†”ë£¨ì…˜ ìƒì„±</h4>

            <div class="data-box">
                <h4>ì†”ë£¨ì…˜ ìƒì„± ì½”ë“œ</h4>
                <pre># ê°™ì€ ë¬¸ì œì— ëŒ€í•´ Nê°œì˜ ë‹¤ë¥¸ ì†”ë£¨ì…˜ ìƒì„± (temperature > 0)

def generate_solutions(question, n_samples=16):
    solutions = []
    for i in range(n_samples):
        output = model.generate(
            prompt=question,
            temperature=0.7,  # ë‹¤ì–‘ì„±ì„ ìœ„í•´
            top_p=0.95,
            max_tokens=1024
        )

        # Step ìˆ˜ í•„í„°ë§: 3-9 stepsë§Œ ìœ íš¨
        steps = extract_steps_from_text(output)
        if 2 < len(steps) < 10:
            solutions.append(output)

    return solutions</pre>
            </div>

            <h4 style="margin-top: 25px; color: #1a365d;">ìƒì„±ëœ 16ê°œ ì†”ë£¨ì…˜ ì˜ˆì‹œ</h4>

            <!-- Solution 1 -->
            <div class="solution-card">
                <div class="solution-header">
                    <strong>Solution #1</strong>
                    <span>ì˜ˆì¸¡: C (COPD)</span>
                </div>
                <div class="solution-body">
                    <p>Step 1 â†’ Step 2 â†’ Step 3 â†’ Step 4 â†’ Step 5 â†’ Answer: C</p>
                    <p style="color: #64748b; font-size: 0.9em;">ì˜¬ë°”ë¥¸ ì¶”ë¡  ê²½ë¡œ</p>
                </div>
            </div>

            <!-- Solution 2 -->
            <div class="solution-card">
                <div class="solution-header">
                    <strong>Solution #2</strong>
                    <span>ì˜ˆì¸¡: C (COPD)</span>
                </div>
                <div class="solution-body">
                    <p>Step 1 â†’ Step 2 â†’ Step 3 â†’ Answer: C</p>
                    <p style="color: #64748b; font-size: 0.9em;">ë” ì§§ì€ ì¶”ë¡ , ì •ë‹µ</p>
                </div>
            </div>

            <!-- Solution 3 (wrong) -->
            <div class="solution-card">
                <div class="solution-header" style="background: #fee2e2;">
                    <strong>Solution #3</strong>
                    <span style="color: #991b1b;">ì˜ˆì¸¡: A (Asthma) âŒ</span>
                </div>
                <div class="solution-body">
                    <p>Step 1 â†’ <span style="color: #991b1b;">Step 2 (ì˜ëª»ëœ í•´ì„)</span> â†’ Step 3 â†’ Answer: A</p>
                    <p style="color: #991b1b; font-size: 0.9em;">Step 2ì—ì„œ "wheezing"ì„ ì˜ëª» ê°€ì •</p>
                </div>
            </div>

            <!-- More solutions indicator -->
            <div style="text-align: center; padding: 15px; color: #64748b;">
                ... (ì´ 16ê°œ ì†”ë£¨ì…˜ ìƒì„±) ...
            </div>

            <div class="data-box">
                <h4>ì¶œë ¥ ë°ì´í„° í˜•ì‹</h4>
                <pre>{
    <span class="json-key">"question"</span>: <span class="json-string">"A 65-year-old man presents with..."</span>,
    <span class="json-key">"answer"</span>: <span class="json-string">"C"</span>,
    <span class="json-key">"solutions"</span>: [
        {
            <span class="json-key">"text"</span>: <span class="json-string">"## Step 1: Analyze... ĞºĞ¸\n## Step 2..."</span>,
            <span class="json-key">"extracted_answer"</span>: <span class="json-string">"C"</span>,
            <span class="json-key">"score"</span>: <span class="json-number">1</span>  <span style="color: #86efac;">// ì •ë‹µì´ë©´ 1</span>
        },
        {
            <span class="json-key">"text"</span>: <span class="json-string">"## Step 1: The patient... ĞºĞ¸\n..."</span>,
            <span class="json-key">"extracted_answer"</span>: <span class="json-string">"A"</span>,
            <span class="json-key">"score"</span>: <span class="json-number">0</span>  <span style="color: #f87171;">// ì˜¤ë‹µì´ë©´ 0</span>
        },
        <span style="color: #64748b;">// ... 16ê°œ ì†”ë£¨ì…˜</span>
    ]
}</pre>
            </div>
        </div>
    </div>

    <!-- Stage 4: PRM Scoring -->
    <div class="stage">
        <div class="stage-header">
            <div class="stage-number">4</div>
            <h3>PRM ì ìˆ˜ ê³„ì‚° (Scoring)</h3>
            <span class="file-name">4_scoring_PRM.py</span>
        </div>
        <div class="stage-content">

            <div class="flow-diagram">
                <div class="flow-box">16 Solutions</div>
                <span class="flow-arrow">â†’</span>
                <div class="flow-box highlight">Trained PRM</div>
                <span class="flow-arrow">â†’</span>
                <div class="flow-box highlight">Step Scores</div>
                <span class="flow-arrow">â†’</span>
                <div class="flow-box success">Best Solution</div>
            </div>

            <h4 style="margin-top: 25px; color: #1a365d;">Step 4-1: ê° ì†”ë£¨ì…˜ì˜ Stepë³„ ì ìˆ˜ ê³„ì‚°</h4>

            <div class="data-box">
                <h4>PRM ì ìˆ˜ ê³„ì‚° ì½”ë“œ</h4>
                <pre>def get_prob(text, model, tokenizer):
    """ê° Stepì˜ '+' í™•ë¥  ê³„ì‚°"""

    # í† í¬ë‚˜ì´ì§•
    inputs = tokenizer(text, return_offsets_mapping=True)

    # "ĞºĞ¸" ìœ„ì¹˜ ì°¾ê¸°
    special_char = " ĞºĞ¸"
    positions = find_special_char_positions(text, inputs.offset_mapping)

    # ëª¨ë¸ ì¶”ë¡ 
    with torch.no_grad():
        outputs = model(inputs.input_ids)
        logits = outputs.logits[0]

    # ê° Step ìœ„ì¹˜ì—ì„œ +/- í™•ë¥  ê³„ì‚°
    plus_probs = []
    for pos in positions:
        two_logits = torch.stack([
            logits[pos][plus_token_id],   # " +"
            logits[pos][minus_token_id]   # " -"
        ])
        probs = torch.softmax(two_logits, dim=0)
        plus_probs.append(probs[0].item())  # "+" í™•ë¥ 

    return {
        "plus_probs": plus_probs,           # ëª¨ë“  step ì ìˆ˜
        "min_plus_prob": min(plus_probs),   # ìµœì†Œê°’ (ë³‘ëª©)
        "final_plus_prob": plus_probs[-1]   # ë§ˆì§€ë§‰ step
    }</pre>
            </div>

            <h4 style="margin-top: 25px; color: #1a365d;">Step 4-2: 16ê°œ ì†”ë£¨ì…˜ ì ìˆ˜ ë¹„êµ</h4>

            <!-- Solution 1 - Best -->
            <div class="solution-card selected">
                <div class="solution-header selected">
                    <strong>ğŸ† Solution #1 (Selected - Best)</strong>
                    <span style="color: #065f46;">ì˜ˆì¸¡: C âœ“</span>
                </div>
                <div class="solution-body">
                    <p><strong>Step-wise Scores:</strong></p>
                    <div class="step-scores">
                        <span class="step-score high">Step 1: 0.94</span>
                        <span class="step-score high">Step 2: 0.91</span>
                        <span class="step-score high">Step 3: 0.89</span>
                        <span class="step-score high">Step 4: 0.92</span>
                        <span class="step-score high">Step 5: 0.88</span>
                        <span class="step-score high">Final: 0.95</span>
                    </div>
                    <p style="margin-top: 15px;">
                        <strong>Min Score: <span style="color: #059669; font-size: 1.2em;">0.88</span></strong>
                        (ëª¨ë“  ë‹¨ê³„ê°€ ë†’ì€ ì ìˆ˜)
                    </p>
                    <div class="score-bar" style="margin-top: 10px;">
                        <div class="score-fill" style="width: 88%;"></div>
                    </div>
                </div>
            </div>

            <!-- Solution 2 -->
            <div class="solution-card">
                <div class="solution-header">
                    <strong>Solution #2</strong>
                    <span>ì˜ˆì¸¡: C âœ“</span>
                </div>
                <div class="solution-body">
                    <p><strong>Step-wise Scores:</strong></p>
                    <div class="step-scores">
                        <span class="step-score high">Step 1: 0.91</span>
                        <span class="step-score medium">Step 2: 0.72</span>
                        <span class="step-score high">Step 3: 0.85</span>
                        <span class="step-score high">Final: 0.90</span>
                    </div>
                    <p style="margin-top: 15px;">
                        <strong>Min Score: <span style="color: #d97706;">0.72</span></strong>
                        (Step 2ê°€ ë³‘ëª©)
                    </p>
                    <div class="score-bar" style="margin-top: 10px;">
                        <div class="score-fill" style="width: 72%; background: linear-gradient(90deg, #d97706, #fbbf24);"></div>
                    </div>
                </div>
            </div>

            <!-- Solution 3 - Wrong -->
            <div class="solution-card">
                <div class="solution-header" style="background: #fee2e2;">
                    <strong>Solution #3</strong>
                    <span style="color: #991b1b;">ì˜ˆì¸¡: A âŒ</span>
                </div>
                <div class="solution-body">
                    <p><strong>Step-wise Scores:</strong></p>
                    <div class="step-scores">
                        <span class="step-score high">Step 1: 0.89</span>
                        <span class="step-score low">Step 2: 0.23</span>
                        <span class="step-score medium">Step 3: 0.65</span>
                        <span class="step-score low">Final: 0.31</span>
                    </div>
                    <p style="margin-top: 15px;">
                        <strong>Min Score: <span style="color: #991b1b;">0.23</span></strong>
                        (Step 2ì—ì„œ ì˜ëª»ëœ ì¶”ë¡  ê°ì§€!)
                    </p>
                    <div class="score-bar" style="margin-top: 10px;">
                        <div class="score-fill" style="width: 23%; background: linear-gradient(90deg, #dc2626, #f87171);"></div>
                    </div>
                </div>
            </div>

            <h4 style="margin-top: 30px; color: #1a365d;">Step 4-3: Best-of-N ì„ íƒ</h4>

            <div class="data-box">
                <h4>ì„ íƒ ì•Œê³ ë¦¬ì¦˜</h4>
                <pre># Min Score ê¸°ì¤€ìœ¼ë¡œ ìµœì„ ì˜ ì†”ë£¨ì…˜ ì„ íƒ

solutions_with_scores = [
    {"idx": 0, "answer": "C", "min_score": 0.88, "score": 1},
    {"idx": 1, "answer": "C", "min_score": 0.72, "score": 1},
    {"idx": 2, "answer": "A", "min_score": 0.23, "score": 0},
    # ... 16ê°œ
]

# Min Scoreê°€ ê°€ì¥ ë†’ì€ ì†”ë£¨ì…˜ ì„ íƒ
best_solution = max(solutions_with_scores, key=lambda x: x["min_score"])

print(f"Selected: Solution #{best_solution['idx']}")
print(f"Predicted Answer: {best_solution['answer']}")  <span style="color: #86efac;"># C</span>
print(f"Is Correct: {best_solution['score'] == 1}")    <span style="color: #86efac;"># True âœ“</span></pre>
            </div>

            <div class="success-callout">
                <strong>ê²°ê³¼:</strong> PRMì´ Step 2ì—ì„œ ì˜ëª»ëœ ì¶”ë¡ ì„ í•œ Solution #3 (ì˜¤ë‹µ A)ì„ ë‚®ì€ ì ìˆ˜(0.23)ë¡œ ì •í™•íˆ í•„í„°ë§í•˜ê³ , ëª¨ë“  ë‹¨ê³„ê°€ ì˜¬ë°”ë¥¸ Solution #1 (ì •ë‹µ C)ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.
            </div>

            <h4 style="margin-top: 30px; color: #1a365d;">ìµœì¢… ì¶œë ¥ í˜•ì‹</h4>

            <div class="data-box">
                <h4>ê²°ê³¼ JSON</h4>
                <pre>{
    <span class="json-key">"question_id"</span>: <span class="json-string">"medqa_001"</span>,
    <span class="json-key">"question"</span>: <span class="json-string">"A 65-year-old man presents with..."</span>,
    <span class="json-key">"correct_answer"</span>: <span class="json-string">"C"</span>,
    <span class="json-key">"solutions"</span>: [
        {
            <span class="json-key">"text"</span>: <span class="json-string">"## Step 1: Analyze..."</span>,
            <span class="json-key">"extracted_answer"</span>: <span class="json-string">"C"</span>,
            <span class="json-key">"prm_scores"</span>: [<span class="json-number">0.94, 0.91, 0.89, 0.92, 0.88, 0.95</span>],
            <span class="json-key">"prm_min_score"</span>: <span class="json-number">0.88</span>,
            <span class="json-key">"score"</span>: <span class="json-number">1</span>
        },
        <span style="color: #64748b;">// ... 16ê°œ ì†”ë£¨ì…˜</span>
    ],
    <span class="json-key">"best_solution_idx"</span>: <span class="json-number">0</span>,
    <span class="json-key">"predicted_answer"</span>: <span class="json-string">"C"</span>,
    <span class="json-key">"is_correct"</span>: <span class="json-number">true</span>
}</pre>
            </div>
        </div>
    </div>

    <!-- Summary -->
    <div class="stage">
        <div class="stage-header" style="background: #059669;">
            <div class="stage-number" style="color: #059669;">âœ“</div>
            <h3>ì „ì²´ íŒŒì´í”„ë¼ì¸ ìš”ì•½</h3>
        </div>
        <div class="stage-content">

            <table>
                <tr>
                    <th>Stage</th>
                    <th>íŒŒì¼</th>
                    <th>ì…ë ¥</th>
                    <th>ì¶œë ¥</th>
                    <th>í•µì‹¬ ë™ì‘</th>
                </tr>
                <tr>
                    <td><strong>0</strong></td>
                    <td>0_preparing.py</td>
                    <td>HuggingFace repo</td>
                    <td>Raw JSON data</td>
                    <td>ë°ì´í„°ì…‹ ë‹¤ìš´ë¡œë“œ</td>
                </tr>
                <tr>
                    <td><strong>1</strong></td>
                    <td>1_train_dataset_RAG_judge_labeling.py</td>
                    <td>Question + Options</td>
                    <td>Labeled Solutions</td>
                    <td>ì†”ë£¨ì…˜ ìƒì„± + RAG ê²€ì¦ + Step ë ˆì´ë¸”ë§</td>
                </tr>
                <tr>
                    <td><strong>2</strong></td>
                    <td>2_training.py</td>
                    <td>Labeled Solutions</td>
                    <td>Trained PRM</td>
                    <td>Binary Lossë¡œ +/- ì˜ˆì¸¡ í•™ìŠµ</td>
                </tr>
                <tr>
                    <td><strong>3</strong></td>
                    <td>3_test_dataset_sampling.py</td>
                    <td>Test Questions</td>
                    <td>Nê°œ Solutions</td>
                    <td>Policy Modelë¡œ ë‹¤ì¤‘ ì†”ë£¨ì…˜ ìƒì„±</td>
                </tr>
                <tr>
                    <td><strong>4</strong></td>
                    <td>4_scoring_PRM.py</td>
                    <td>Nê°œ Solutions</td>
                    <td>Best Answer</td>
                    <td>Stepë³„ ì ìˆ˜ ê³„ì‚° + Best-of-N ì„ íƒ</td>
                </tr>
            </table>

            <div class="flow-diagram" style="margin-top: 25px;">
                <div class="flow-box">Question</div>
                <span class="flow-arrow">â†’</span>
                <div class="flow-box">Policy Model</div>
                <span class="flow-arrow">â†’</span>
                <div class="flow-box highlight">16 Solutions</div>
                <span class="flow-arrow">â†’</span>
                <div class="flow-box highlight">PRM Score</div>
                <span class="flow-arrow">â†’</span>
                <div class="flow-box success">Best Answer<br><small>(C: COPD)</small></div>
            </div>

            <div class="success-callout" style="margin-top: 25px;">
                <strong>í•µì‹¬ ì¸ì‚¬ì´íŠ¸:</strong><br>
                â€¢ PRMì€ ìµœì¢… ë‹µë³€ë§Œ ë³´ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ <strong>ê° ì¶”ë¡  ë‹¨ê³„ì˜ í’ˆì§ˆ</strong>ì„ í‰ê°€í•©ë‹ˆë‹¤<br>
                â€¢ <strong>Min Score</strong> ê¸°ì¤€ìœ¼ë¡œ ì„ íƒí•˜ë©´ "ì–´ë””ì„ ê°€ ì˜ëª»ëœ ì¶”ë¡ "ì„ í•œ ì†”ë£¨ì…˜ì„ í•„í„°ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                â€¢ RAG-AS-A-JUDGEë¥¼ í†µí•´ ì˜í•™ ë¬¸í—Œ ê¸°ë°˜ì˜ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë ˆì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤<br>
                â€¢ Best-of-32 + RAG ì¡°í•©ìœ¼ë¡œ MedQAì—ì„œ <strong>80.35% ì •í™•ë„</strong> ë‹¬ì„±
            </div>
        </div>
    </div>

</div>

<footer>
    <p>Med-PRM Data Flow - Case Study</p>
    <p>Based on: <a href="https://github.com/eth-medical-ai-lab/Med-PRM" style="color: #2563eb;">https://github.com/eth-medical-ai-lab/Med-PRM</a></p>
</footer>

</body>
</html>